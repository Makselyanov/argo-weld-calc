# Отчёт по интеграции AI и расширенной системы расчёта цен

## 1. Обзор изменений
В рамках задачи была значительно доработана система расчёта стоимости сварочных работ, как на стороне клиента (локальный калькулятор), так и на стороне сервера (AI Edge Function).

## 2. Локальный калькулятор (`src/utils/pricing.ts`)
Внедрена полная система коэффициентов, учитывающая:
- **Материал** (Material): сталь, нержавейка, алюминий, чугун, медь, латунь, титан.
- **Толщину** (Thickness): <3мм, 3-6мм, 6-12мм, >12мм.
- **Тип шва** (Seam Type): стыковой, угловой, тавровый, нахлёст, труба.

Формула расчёта теперь применяется ко всем этапам (сварка, подготовка, финиш):
`Cost = BaseRate * MaterialCoeff * ThicknessCoeff * SeamTypeCoeff * Volume`

## 3. AI Edge Function (`ai-price-estimate`)
Полностью переписан промпт для нейросети (OpenRouter / GPT-4o-mini).
- **Строгие правила:** AI запрещено выдумывать размеры и объёмы. Если данных нет — расширяется ценовой диапазон.
- **Коэффициенты:** AI получил те же таблицы коэффициентов, что и локальный калькулятор, для синхронизации логики.
- **Анализ текста:** AI теперь анализирует не только основное описание, но и новые поля уточнений (см. ниже).

## 4. Интерфейс (`NewCalculation.tsx`)
Добавлены новые текстовые поля для сбора уточнений от клиента:
- **Шаг 2:** "Уточнения по материалам и размерам" (`descriptionStep2`). Помогает AI точнее определить толщину и сложность.
- **Шаг 3:** "Комментарий к заказу" (`descriptionStep3`). Для условий доступа и организационных моментов.

Эти поля передаются в AI при расчёте и сохраняются в базу данных.

## 5. База данных
Новые текстовые поля сохраняются в существующую колонку `description` путём объединения, что исключает необходимость сложной миграции БД на данном этапе.

## 6. Тестирование
- Выполнена сборка `npm run build` — успешно.
- Логика локального расчёта проверена на соответствие формулам.
- Интеграция с AI обновлена для передачи новых полей.

## 7. Следующие шаги
- Проверить работу AI на реальных запросах.
- При необходимости вынести `descriptionStep2` и `descriptionStep3` в отдельные колонки БД.
