import { serve } from "https://deno.land/std@0.177.0/http/server.ts";

const OPENROUTER_API_KEY = Deno.env.get("OPENROUTER_API_KEY");
const OPENROUTER_MODEL = Deno.env.get("OPENROUTER_MODEL") || "openai/gpt-4o-mini";

const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
    'Access-Control-Allow-Methods': 'POST, OPTIONS',
};

serve(async (req) => {
    if (req.method === 'OPTIONS') {
        return new Response('ok', { headers: corsHeaders });
    }

    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ API –∫–ª—é—á–∞
        if (!OPENROUTER_API_KEY) {
            console.error("Missing OPENROUTER_API_KEY");
            return new Response(
                JSON.stringify({
                    aiMin: null,
                    aiMax: null,
                    aiFailed: true,
                    reasonShort: 'API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω',
                    reasonLong: '–°–µ—Ä–≤–µ—Ä –Ω–µ —Å–º–æ–≥ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ò–ò. –ü–æ–∫–∞–∑–∞–Ω–∞ –±–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É.',
                    warnings: []
                }),
                { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
            );
        }

        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        let data;
        let rawBody = '';
        try {
            rawBody = await req.text();
            console.log('Raw request body (first 1000 chars):', rawBody.slice(0, 1000));
            data = JSON.parse(rawBody);
        } catch (err) {
            console.error('Failed to parse request JSON in ai-price-estimate:', err);
            console.error('Raw body (first 1000 chars):', rawBody.slice(0, 1000));
            return new Response(
                JSON.stringify({
                    aiMin: null,
                    aiMax: null,
                    aiFailed: true,
                    reasonShort: '–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ –∑–∞–ø—Ä–æ—Å–∞',
                    reasonLong: '–°–µ—Ä–≤–µ—Ä –Ω–µ —Å–º–æ–≥ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–∞—Å—á—ë—Ç–∞. –ü–æ–∫–∞–∑–∞–Ω–∞ –±–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É.',
                    warnings: []
                }),
                { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
            );
        }

        // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º—Ç –¥–ª—è AI —Å –∂—ë—Å—Ç–∫–∏–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏
        const prompt = `–¢—ã –æ–ø—ã—Ç–Ω—ã–π –º–∞—Å—Ç–µ—Ä-—Å–≤–∞—Ä—â–∏–∫ —Å 20-–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º —Ä–∞–±–æ—Ç—ã –≤ –†–æ—Å—Å–∏–∏. 
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞—è–≤–∫—É –Ω–∞ —Å–≤–∞—Ä–æ—á–Ω—ã–µ —Ä–∞–±–æ—Ç—ã –∏ –¥–∞–π —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—É—é –æ—Ü–µ–Ω–∫—É —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤ —Ä—É–±–ª—è—Ö (‚ÇΩ).

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìã –î–ê–ù–ù–´–ï –ó–ê–Ø–í–ö–ò
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

**–°–¢–†–£–ö–¢–£–†–ò–†–û–í–ê–ù–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´ (–∏–∑ —Ñ–æ—Ä–º—ã):**
- –¢–∏–ø —Ä–∞–±–æ—Ç: ${data.typeOfWork || "–Ω–µ —É–∫–∞–∑–∞–Ω"}
- –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: ${data.workScope ?
                (data.workScope === 'pre_cut' ? '–°–≤–∞—Ä–∫–∞ –∏–∑ –∑–∞–≥–æ—Ç–æ–≤–æ–∫ (–¥–µ—Ç–∞–ª–∏ —É–∂–µ –Ω–∞—Ä–µ–∑–∞–Ω—ã, —Ç–æ–ª—å–∫–æ —Å–±–æ—Ä–∫–∞ –∏ —Å–≤–∞—Ä–∫–∞)' :
                    data.workScope === 'from_scratch' ? '–ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ —Å –Ω—É–ª—è (—Ä–∞–∑–º–µ—Ç–∫–∞, —Ä–µ–∑–∫–∞, –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫—Ä–æ–º–æ–∫, –ø–æ–¥–≥–æ–Ω–∫–∞, —Å–±–æ—Ä–∫–∞, —Å–≤–∞—Ä–∫–∞)' :
                        data.workScope === 'rework' ? '–ü–µ—Ä–µ–¥–µ–ª–∫–∞/—Ä–µ–º–æ–Ω—Ç (—Ä–∞–∑–±–æ—Ä–∫–∞, —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —à–≤–æ–≤, –¥–æ—Ä–∞–±–æ—Ç–∫–∞, —Å–≤–∞—Ä–∫–∞)' :
                            data.workScope) : "–Ω–µ —É–∫–∞–∑–∞–Ω"}
- –ú–∞—Ç–µ—Ä–∏–∞–ª: ${data.material || "–Ω–µ —É–∫–∞–∑–∞–Ω"}
- –¢–æ–ª—â–∏–Ω–∞: ${data.thickness || "–Ω–µ —É–∫–∞–∑–∞–Ω–∞"}
- –¢–∏–ø —à–≤–∞: ${data.seamType || "–Ω–µ —É–∫–∞–∑–∞–Ω"}
- –î–ª–∏–Ω–∞ —à–≤–æ–≤: ${data.volume || "–Ω–µ —É–∫–∞–∑–∞–Ω–∞"}
- –ü–æ–ª–æ–∂–µ–Ω–∏–µ: ${data.position || "–Ω–µ —É–∫–∞–∑–∞–Ω–æ"}
- –£—Å–ª–æ–≤–∏—è —Ä–∞–±–æ—Ç—ã: ${data.conditions?.join(", ") || "–æ–±—ã—á–Ω—ã–µ"}
- –ú–∞—Ç–µ—Ä–∏–∞–ª: ${data.materialOwner === "client" ? "–∑–∞–∫–∞–∑—á–∏–∫–∞" : "–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è"}
- –°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${data.deadline || "–æ–±—ã—á–Ω—ã–π"}
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏: ${data.extraServices?.join(", ") || "–Ω–µ—Ç"}

**–ë–ê–ó–û–í–´–ô –î–ò–ê–ü–ê–ó–û–ù –õ–û–ö–ê–õ–¨–ù–û–ì–û –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–†–ê:**
- –ú–∏–Ω–∏–º—É–º: ${data.localMin || 0} ‚ÇΩ
- –ú–∞–∫—Å–∏–º—É–º: ${data.localMax || 0} ‚ÇΩ

**–¢–ï–ö–°–¢–û–í–´–ï –ü–û–õ–Ø –ö–õ–ò–ï–ù–¢–ê:**
- –û–ø–∏—Å–∞–Ω–∏–µ (–®–∞–≥ 1): ${data.description || "–Ω–µ—Ç"}
- –£—Ç–æ—á–Ω–µ–Ω–∏—è –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º (–®–∞–≥ 2): ${data.descriptionStep2 || "–Ω–µ—Ç"}
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ —É—Å–ª–æ–≤–∏—è–º (–®–∞–≥ 3): ${data.descriptionStep3 || "–Ω–µ—Ç"}

**–°–õ–£–ñ–ï–ë–ù–´–ï –î–ê–ù–ù–´–ï:**
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ: ${data.photos?.length || 0} —à—Ç.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üö´ –°–¢–†–û–ì–ò–ï –ü–†–ê–í–ò–õ–ê (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´ –î–õ–Ø –í–´–ü–û–õ–ù–ï–ù–ò–Ø)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

1. **–ó–ê–ü–†–ï–©–ï–ù–û –í–´–î–£–ú–´–í–ê–¢–¨ –î–ê–ù–ù–´–ï**
   ‚ùå –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ä–∞–∑–º–µ—Ä—ã, –¥–ª–∏–Ω—É —à–≤–æ–≤, —Ç–æ–ª—â–∏–Ω—É, –º–∞—Ç–µ—Ä–∏–∞–ª, —Ç–∏–ø —à–≤–∞
   ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —Ç–µ —á–∏—Å–ª–∞ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ —è–≤–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω—ã –∏–∑ —Ñ–æ—Ä–º—ã –∏–ª–∏ –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π
   ‚úÖ –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç ‚Äî —É–∫–∞–∂–∏ —ç—Ç–æ –≤ warnings

2. **–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï –¢–ï–ö–°–¢–û–í–´–• –ü–û–õ–ï–ô**
   - –¢–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è (descriptionStep2, descriptionStep3) –∏—Å–ø–æ–ª—å–∑—É–π –¥–ª—è:
     * –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ç–∏–ø–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
     * –æ—Ü–µ–Ω–∫–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–∞
     * –æ—Ü–µ–Ω–∫–∏ —Ä–∏—Å–∫–æ–≤ (–≤—ã—Å–æ—Ç–∞, —Å—Ç–µ—Å–Ω—ë–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø, –æ–ø–∞—Å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è)
   - –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω—ã —Ä–∞–∑–º–µ—Ä—ã/—Ç–æ–ª—â–∏–Ω–∞/–º–∞—Ç–µ—Ä–∏–∞–ª:
     * –ï—Å–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –ø–æ–ª–µ —Ñ–æ—Ä–º—ã –ø—É—Å—Ç–æ–µ –∏–ª–∏ "–ù–µ –∑–Ω–∞—é" ‚Äî –º–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞
     * –ï—Å–ª–∏ –ø–æ–ª–µ —Ñ–æ—Ä–º—ã –∑–∞–ø–æ–ª–Ω–µ–Ω–æ ‚Äî –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —É —Ñ–æ—Ä–º—ã, —Ç–µ–∫—Å—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
   - –ü—Ä–∏–º–µ—Ä—ã —É—Å–ª–æ–∂–Ω—è—é—â–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤ –∏–∑ —Ç–µ–∫—Å—Ç–∞:
     * "–Ω–∞ –≤—ã—Å–æ—Ç–µ", "–Ω–∞–¥ –¥–æ—Ä–æ–≥–æ–π", "–Ω–∞–¥ –≤–æ–¥–æ–π", "–≤ –∫–æ–ª–æ–¥—Ü–µ"
     * "—Ç–µ—Å–Ω–æ –ø–æ–¥–ª–µ–∑—Ç—å", "–Ω—É–∂–Ω–æ –Ω–æ—á—å—é", "–≥–æ—Ä—è—á–∏–π —Ç—Ä—É–±–æ–ø—Ä–æ–≤–æ–¥"
     * "–∂—ë—Å—Ç–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ù–ö", "–æ–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞", "–¥–µ–π—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏"

3. **–§–û–¢–û–ì–†–ê–§–ò–ò**
   - –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ç–æ –¢–û–õ–¨–ö–û –¥–ª—è:
     * –æ—Ü–µ–Ω–∫–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–∞
     * –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
     * –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–≤–∞—Ä–∫–∞
   - ‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ç–æ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ –∏–ª–∏ —Ç–æ–ª—â–∏–Ω—ã "–Ω–∞ –≥–ª–∞–∑"

4. **–†–ï–ñ–ò–ú –†–ê–ë–û–¢–´ (workScope) ‚Äî –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –î–õ–Ø –û–¶–ï–ù–ö–ò**
   –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –Ω–∞–ø—Ä—è–º—É—é –≤–ª–∏—è–µ—Ç –Ω–∞ —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã –∏ —É–∂–µ –£–ß–¢–Å–ù –≤ localMin/localMax.
   –õ–æ–∫–∞–ª—å–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã:
   
   üì¶ **pre_cut (–°–≤–∞—Ä–∫–∞ –∏–∑ –∑–∞–≥–æ—Ç–æ–≤–æ–∫)** ‚Äî –ë–ê–ó–û–í–´–ô –£–†–û–í–ï–ù–¨ (1.0x)
      - –î–µ—Ç–∞–ª–∏ —É–∂–µ –Ω–∞—Ä–µ–∑–∞–Ω—ã, –∫—Ä–æ–º–∫–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã
      - –ù—É–∂–Ω–∞ —Ç–æ–ª—å–∫–æ —Å–±–æ—Ä–∫–∞ –∏ —Å–≤–∞—Ä–∫–∞
      - –ú–∏–Ω–∏–º—É–º –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞–±–æ—Ç
      - –≠—Ç–æ —Å–∞–º—ã–π –¥–µ—à—ë–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
   
   üèóÔ∏è **from_scratch (–ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ —Å –Ω—É–ª—è)** ‚Äî –î–û–†–û–ñ–ï –Ω–∞ 40-80%
      - –†–∞–∑–º–µ—Ç–∫–∞ –∑–∞–≥–æ—Ç–æ–≤–æ–∫ –ø–æ —á–µ—Ä—Ç–µ–∂–∞–º
      - –†–µ–∑–∫–∞ –º–µ—Ç–∞–ª–ª–∞ (–±–æ–ª–≥–∞—Ä–∫–æ–π, –ø–ª–∞–∑–º–æ–π, –≥–∏–ª—å–æ—Ç–∏–Ω–æ–π)
      - –ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫—Ä–æ–º–æ–∫ –ø–æ–¥ —Å–≤–∞—Ä–∫—É
      - –ü–æ–¥–≥–æ–Ω–∫–∞ –¥–µ—Ç–∞–ª–µ–π (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑–∫–∏, –ø–æ–¥–ø–∏–ª–∏–≤–∞–Ω–∏–µ)
      - –°–±–æ—Ä–∫–∞ –≤ –ø—Ä–∏—Å–ø–æ—Å–æ–±–ª–µ–Ω–∏—è—Ö –∏–ª–∏ –ø—Ä–∏—Ö–≤–∞—Ç–∫–∞–º–∏
      - –°–≤–∞—Ä–∫–∞
      - –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã: weld=1.15x, prep=1.8x (—Ä–µ–∑–∫–∞+–ø–æ–¥–≥–æ–Ω–∫–∞), finish=1.2x
   
   üîß **rework (–ü–µ—Ä–µ–¥–µ–ª–∫–∞/—Ä–µ–º–æ–Ω—Ç)** ‚Äî –°–ê–ú–´–ô –î–û–†–û–ì–û–ô (+60-100%)
      - –†–∞–∑–±–æ—Ä–∫–∞/–¥–µ–º–æ–Ω—Ç–∞–∂ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
      - –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Å–≤–∞—Ä–Ω—ã—Ö —à–≤–æ–≤ (–∑–∞—á–∏—Å—Ç–∫–∞, –≤—ã—Ä—É–±–∫–∞, —Å—Ä–µ–∑–∫–∞)
      - –ó–∞—á–∏—Å—Ç–∫–∞ –∑–∞–≥—Ä—è–∑–Ω—ë–Ω–Ω–æ–≥–æ –º–µ—Ç–∞–ª–ª–∞, —Ä–∂–∞–≤—á–∏–Ω—ã, –∫—Ä–∞—Å–∫–∏
      - –°–ª–æ–∂–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –º–µ—Å—Ç–∞–º —Å–≤–∞—Ä–∫–∏ (–Ω–µ—É–¥–æ–±–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ)
      - –ü–æ–¥–≥–æ–Ω–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–µ—Ç–∞–ª–µ–π (–¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—è, –∫–æ—Ä—Ä–æ–∑–∏—è)
      - –°–≤–∞—Ä–∫–∞ –≤ –Ω–µ—É–¥–æ–±–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö, —á–∞—Å—Ç–æ –ø–æ —Å—Ç–∞—Ä–æ–º—É –º–µ—Ç–∞–ª–ª—É
      - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏: —Å–∫—Ä—ã—Ç—ã–µ –¥–µ—Ñ–µ–∫—Ç—ã, —Ç—Ä–µ—â–∏–Ω—ã, –Ω–µ–ø—Ä–æ–≤–∞—Ä–µ–Ω–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏
      - –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã: weld=1.25x, prep=2.0x (—Ä–∞–∑–±–æ—Ä–∫–∞+–∑–∞—á–∏—Å—Ç–∫–∞), finish=1.4x
   
   **–¢–í–û–Ø –ó–ê–î–ê–ß–ê:**
   - –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ localMin/localMax –£–ñ–ï –≤–∫–ª—é—á–∞–µ—Ç workScope
   - –ù–ï —É–≤–µ–ª–∏—á–∏–≤–∞–π —Ü–µ–Ω—É –ø–æ–≤—Ç–æ—Ä–Ω–æ –∑–∞ —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
   - –ù–æ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ–±—ä—è—Å–Ω–∏ –≤ reason_long, –ø–æ—á–µ–º—É –¥–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –¥–æ—Ä–æ–∂–µ/–¥–µ—à–µ–≤–ª–µ
   - –î–ª—è from_scratch –∏ rework —É–ø–æ–º—è–Ω–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã (—Ä–µ–∑–∫–∞, —Ä–∞–∑–±–æ—Ä–∫–∞, –∑–∞—á–∏—Å—Ç–∫–∞)
   - –î–ª—è rework –¥–æ–±–∞–≤—å –≤ warnings —Ä–∏—Å–∫–∏: —Å–∫—Ä—ã—Ç—ã–µ –¥–µ—Ñ–µ–∫—Ç—ã, –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ—Ç–∞–ª–ª–∞

5. **–ö–û–†–†–ï–ö–¢–ò–†–û–í–ö–ê –ë–ê–ó–û–í–û–ì–û –î–ò–ê–ü–ê–ó–û–ù–ê –¶–ï–ù–´**
   –õ–æ–∫–∞–ª—å–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–∞—ë—Ç –±–∞–∑–æ–≤—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω localMin‚ÄìlocalMax –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π.
   
   **–ü—Ä–∞–≤–∏–ª–∞ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏:**
   - –í —Ç–∏–ø–æ–≤—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö: –º–æ–∂–µ—à—å —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ¬±30% –æ—Ç localMin/localMax
   - –ü—Ä–∏ —è–≤–Ω—ã—Ö —É—Å–ª–æ–∂–Ω—è—é—â–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–∞—Ö: –¥–æ +50% –º–∞–∫—Å–∏–º—É–º
     (–≤—ã—Å–æ—Ç–∞, –Ω–æ—á–Ω—ã–µ —Ä–∞–±–æ—Ç—ã, —Å—Ç–µ—Å–Ω—ë–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø, —Å—Ä–æ—á–Ω–æ, –∂—ë—Å—Ç–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ù–ö, –æ–ø–∞—Å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è)
   - ‚ùå –ù–ï–õ–¨–ó–Ø —É–º–µ–Ω—å—à–∞—Ç—å —Ü–µ–Ω—É –Ω–∏–∂–µ localMin
   - ‚ùå –ù–ï–õ–¨–ó–Ø —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –±–æ–ª–µ–µ —á–µ–º –≤ 1.5 —Ä–∞–∑–∞ –±–µ–∑ –∫—Ä–∞–π–Ω–µ –≤–µ—Å–∫–∏—Ö –ø—Ä–∏—á–∏–Ω

6. **–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê**
   –í–µ—Ä–Ω–∏ –°–¢–†–û–ì–û JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞:
   {
     "price_range": {
       "min": number,
       "max": number
     },
     "reason_short": "–ö–æ—Ä–æ—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –¥–ª—è –±–ª–æ–∫–∞ —Ä—è–¥–æ–º —Å —Ü–µ–Ω–æ–π (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)",
     "reason_long": "–†–∞–∑–≤—ë—Ä–Ω—É—Ç–æ–µ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç –ª–∏—Ü–∞ –æ–ø—ã—Ç–Ω–æ–≥–æ —Å–≤–∞—Ä—â–∏–∫–∞",
     "warnings": ["–°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–ª–∏ –Ω—É–∂–µ–Ω –≤—ã–µ–∑–¥"]
   }

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìù –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –°–û–î–ï–†–ñ–ê–ù–ò–Æ –û–¢–í–ï–¢–ê
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

**reason_short:**
- 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
- –ö–æ—Ä–æ—Ç–∫–æ, –ø–æ–Ω—è—Ç–Ω—ã–º —è–∑—ã–∫–æ–º
- –ë–µ–∑ –ø–∞—Ñ–æ—Å–∞ –∏ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–≥–æ –±—Ä–µ–¥–∞
- –û–±—ä—è—Å–Ω–∏ –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã —Ü–µ–Ω—ã

**reason_long (–≥–æ—Ç–æ–≤–æ–µ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç—É):**
- –û–±—ä—ë–º: 800‚Äì1200 —Å–∏–º–≤–æ–ª–æ–≤
- –§–æ—Ä–º–∞—Ç: 3‚Äì5 –∞–±–∑–∞—Ü–µ–≤, —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã—Ö –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ —Å—Ç—Ä–æ–∫ (\n\n –º–µ–∂–¥—É –∞–±–∑–∞—Ü–∞–º–∏)
- –ë–ï–ó —ç–º–æ–¥–∑–∏, –ë–ï–ó —Å–º–∞–π–ª–∏–∫–æ–≤, –ë–ï–ó —É–ø–æ–º–∏–Ω–∞–Ω–∏–π –ø—Ä–æ –ò–ò –∏–ª–∏ –Ω–µ–π—Ä–æ—Å–µ—Ç—å
- –ë–ï–ó —Å–ø–∏—Å–∫–æ–≤ –∏ –º–∞—Ä–∫–µ—Ä–æ–≤ ‚Äì —Ç–æ–ª—å–∫–æ –∂–∏–≤–æ–π —Å–≤—è–∑–Ω—ã–π —Ç–µ–∫—Å—Ç –∞–±–∑–∞—Ü–∞–º–∏
- –°—Ç–∏–ª—å: –¥–µ–ª–æ–≤–æ–π, –Ω–æ –∂–∏–≤–æ–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π, –±–µ–∑ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—Ç–∞ –∏ –ø–∞—Ñ–æ—Å–∞
- –û–±—Ä–∞—â–µ–Ω–∏–µ –ë–ï–ó –∏–º–µ–Ω–∏ (–ø—Ä–æ—Å—Ç–æ ¬´–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ¬ª)

–°–¢–†–£–ö–¢–£–†–ê –ö–ü (–∫–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç ‚Äì —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∞–±–∑–∞—Ü):

–ê–±–∑–∞—Ü 1 (–≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ):
–í–µ–∂–ª–∏–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ. –ö—Ä–∞—Ç–∫–æ —á—Ç–æ –∑–∞ –∑–∞–¥–∞—á–∞: —Ç–∏–ø —Ä–∞–±–æ—Ç—ã, –º–∞—Ç–µ—Ä–∏–∞–ª, –æ–±—ä—ë–º, –æ—Å–Ω–æ–≤–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –∏–∑ –ø–æ–ª–µ–π description, typeOfWork, material, seamType, volume, workScope. –£–ø–æ–º—è–Ω–∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω–æ–º: –æ—Ç [price_range.min] –¥–æ [price_range.max] ‚ÇΩ.

–ê–±–∑–∞—Ü 2 (–∏–∑ —á–µ–≥–æ —Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è —Ü–µ–Ω–∞):
–û–±—ä—è—Å–Ω–∏, –ø–æ—á–µ–º—É —Ç–∞–∫–∏–µ –¥–µ–Ω—å–≥–∏. –û–ø–∏—à–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —ç—Ç–∞–ø—ã —Ä–∞–±–æ—Ç—ã: —Ä–∞–∑–º–µ—Ç–∫–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞, —Ä–µ–∑–∫–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫—Ä–æ–º–æ–∫ (–µ—Å–ª–∏ from_scratch –∏–ª–∏ rework), —Å–±–æ—Ä–∫–∞, —Å–∞–º–∞ —Å–≤–∞—Ä–∫–∞, –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ —à–≤–æ–≤. –£–ø–æ–º—è–Ω–∏ —Ñ–∞–∫—Ç–æ—Ä—ã, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ —Å—Ç–æ–∏–º–æ—Å—Ç—å: —Å–ª–æ–∂–Ω–æ—Å—Ç—å –¥–æ—Å—Ç—É–ø–∞, –ø–æ–ª–æ–∂–µ–Ω–∏–µ —à–≤–∞, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –≤—ã–µ–∑–¥–∞, —É—Å–ª–æ–≤–∏—è —Ä–∞–±–æ—Ç—ã (–≤—ã—Å–æ—Ç–∞, —Å—Ç–µ—Å–Ω—ë–Ω–Ω–æ—Å—Ç—å, —Å—Ä–æ—á–Ω–æ—Å—Ç—å).

–ê–±–∑–∞—Ü 3 (—Ä–∏—Å–∫–∏ –¥–µ—à—ë–≤—ã—Ö –ø–æ–¥—Ä—è–¥—á–∏–∫–æ–≤):
–û–±—ä—è—Å–Ω–∏, —á–µ–º –æ–ø–∞—Å–Ω–æ ¬´—Å–¥–µ–ª–∞—Ç—å –¥—ë—à–µ–≤–æ¬ª. –ß–µ—Å—Ç–Ω–æ –∏ –±–µ–∑ –∑–∞–ø—É–≥–∏–≤–∞–Ω–∏—è —Ä–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ —Ä–∏—Å–∫–∏: –∫—Ä–∏–≤—ã–µ —à–≤—ã, –ø—Ä–æ—Ç–µ—á–∫–∏ –ø—Ä–∏ –∏—Å–ø—ã—Ç–∞–Ω–∏—è—Ö, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ–¥–µ–ª–æ–∫, –ø—Ä–æ—Å—Ç–æ–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, –ø—Ä–æ–±–ª–µ–º—ã —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é –∏ —Ç–µ—Ö—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏. –ü–æ–∫–∞–∂–∏, —á—Ç–æ —ç–∫–æ–Ω–æ–º–∏—è –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–µ –≤—ã—Ö–æ–¥–∏—Ç –¥–æ—Ä–æ–∂–µ.

–ê–±–∑–∞—Ü 4 (—á—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç):
–û–±—ä—è—Å–Ω–∏ –≤—ã–≥–æ–¥—É —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∞–º–∏: –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–µ —Ä–æ–≤–Ω—ã–µ —à–≤—ã, —Å–æ–±–ª—é–¥–µ–Ω–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –ì–û–°–¢–æ–≤ (–±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤), –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞, –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –∞–∫—Ç—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏. –ê–∫—Ü–µ–Ω—Ç –Ω–∞ ¬´–¥–µ–ª–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑ –∏ –Ω–∞–¥–æ–ª–≥–æ¬ª, –∞ –Ω–µ –Ω–∞ ¬´–º—ã –ª—É—á—à–∏–µ¬ª.

–ê–±–∑–∞—Ü 5 (–ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é):
–ö–æ—Ä–æ—Ç–∫–∏–π –∏ –º—è–≥–∫–∏–π. –†–∞—Å—á—ë—Ç –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π, –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –ø–æ—Å–ª–µ –≤—ã–µ–∑–¥–∞/—á–µ—Ä—Ç–µ–∂–µ–π/—Ñ–æ—Ç–æ. –ü—Ä–µ–¥–ª–æ–∂–∏ —É—Ç–æ—á–Ω–∏—Ç—å –¥–µ—Ç–∞–ª–∏, —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å —Å—Ä–æ–∫–∏. –§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –≤—Ä–æ–¥–µ: ¬´–ï—Å–ª–∏ –≤–∞—Å —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω, –º–æ–∂–µ–º –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—é –¥–µ—Ç–∞–ª–µ–π –∏ —Å–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ—á–Ω–æ–µ –ö–ü¬ª.

–í–ê–ñ–ù–û: –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω —á–∏—Ç–∞—Ç—å—Å—è –∫–∞–∫ —Ü–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ, –∞ –Ω–µ –∫–∞–∫ –Ω–∞–±–æ—Ä –ø—É–Ω–∫—Ç–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–π –∂–∏–≤—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É –∞–±–∑–∞—Ü–∞–º–∏, –º–µ—Å—Ç–æ–∏–º–µ–Ω–∏—è, —Å–≤—è–∑–∫–∏.

**warnings:**
- –ò—Å–ø–æ–ª—å–∑—É–π, –µ—Å–ª–∏:
  * –¥–∞–Ω–Ω—ã–µ –∏—Å—Ö–æ–¥–Ω—ã–µ –Ω–µ—Ç–æ—á–Ω—ã–µ –∏–ª–∏ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã–µ
  * –Ω—É–∂–µ–Ω –≤—ã–µ–∑–¥ –¥–ª—è —Ç–æ—á–Ω–æ–π –æ—Ü–µ–Ω–∫–∏
  * –µ—Å—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏
  * —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- –ï—Å–ª–∏ –≤—Å—ë —è—Å–Ω–æ ‚Äî –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º []

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞—è–≤–∫—É –∏ –≤–µ—Ä–Ω–∏ JSON —Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∞–≤–∏–ª–∞–º –≤—ã—à–µ.`;

        // –í—ã–∑—ã–≤–∞–µ–º OpenRouter API —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Ç–∞–π–º–∞—É—Ç–∞
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000); // —Ç–∞–π–º–∞—É—Ç 15 —Å–µ–∫—É–Ω–¥

        let response;
        try {
            response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
                    "Content-Type": "application/json",
                    "HTTP-Referer": "https://argo-weld-calc.com",
                    "X-Title": "ARGO Weld Calculator"
                },
                body: JSON.stringify({
                    model: OPENROUTER_MODEL,
                    messages: [
                        {
                            role: "user",
                            content: prompt
                        }
                    ],
                    response_format: { type: "json_object" },
                    temperature: 0.3,
                    max_tokens: 2500 // —É–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ –ö–ü (800-1200 —Å–∏–º–≤–æ–ª–æ–≤)
                }),
                signal: controller.signal
            });
        } catch (fetchError) {
            clearTimeout(timeoutId);
            console.error("OpenRouter fetch error:", fetchError);
            return new Response(
                JSON.stringify({
                    aiMin: null,
                    aiMax: null,
                    aiFailed: true,
                    reasonShort: '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ò–ò',
                    reasonLong: '–°–µ—Ä–≤–µ—Ä –Ω–µ —Å–º–æ–≥ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ò–ò. –ü–æ–∫–∞–∑–∞–Ω–∞ –±–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É.',
                    warnings: []
                }),
                { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
            );
        }

        clearTimeout(timeoutId);

        if (!response.ok) {
            const errorData = await response.text();
            console.error("OpenRouter API error:", errorData);
            return new Response(
                JSON.stringify({
                    aiMin: null,
                    aiMax: null,
                    aiFailed: true,
                    reasonShort: '–û—à–∏–±–∫–∞ API –ò–ò',
                    reasonLong: '–°–µ—Ä–≤–µ—Ä –Ω–µ —Å–º–æ–≥ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò. –ü–æ–∫–∞–∑–∞–Ω–∞ –±–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É.',
                    warnings: []
                }),
                { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
            );
        }

        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç OpenRouter
        const raw = await response.text();
        console.log('OpenRouter raw response (first 1000 chars):', raw.slice(0, 1000));

        let aiResponse: any;
        try {
            aiResponse = JSON.parse(raw);
        } catch (err) {
            console.error('Failed to parse OpenRouter JSON in ai-price-estimate:', err);
            console.error('Raw response:', raw);
            return new Response(
                JSON.stringify({
                    aiFailed: true,
                    reasonShort: '–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –ò–ò',
                    reasonLong: '–°–µ—Ä–≤–µ—Ä –Ω–µ —Å–º–æ–≥ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–∞—Å—á—ë—Ç–∞. –ü–æ–∫–∞–∑–∞–Ω–∞ –±–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É.',
                    warnings: ['–°–ª—É–∂–µ–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å JSON –≤ Edge-—Ñ—É–Ω–∫—Ü–∏–∏.'],
                    aiMin: null,
                    aiMax: null,
                }),
                { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
            );
        }

        const content = aiResponse.choices?.[0]?.message?.content;

        if (!content) {
            console.error("No content in AI response");
            return new Response(
                JSON.stringify({
                    aiMin: null,
                    aiMax: null,
                    aiFailed: true,
                    reasonShort: '–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò',
                    reasonLong: '–ò–ò –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç. –ü–æ–∫–∞–∑–∞–Ω–∞ –±–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É.',
                    warnings: []
                }),
                { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
            );
        }

        // –õ–æ–≥–∏—Ä—É–µ–º —Å—ã—Ä–æ–π –æ—Ç–≤–µ—Ç –ò–ò
        console.log('AI raw response content:', content);

        // –ü–∞—Ä—Å–∏–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ AI
        let aiResult;
        try {
            aiResult = JSON.parse(content);
            console.log('AI parsed result:', JSON.stringify(aiResult));
        } catch (parseError) {
            console.error("Failed to parse AI response:", parseError);
            console.error("AI raw content:", content);
            return new Response(
                JSON.stringify({
                    aiMin: null,
                    aiMax: null,
                    aiFailed: true,
                    reasonShort: '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞ –ò–ò',
                    reasonLong: '–ò–ò –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö. –ü–æ–∫–∞–∑–∞–Ω–∞ –±–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É.',
                    warnings: []
                }),
                { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
            );
        }

        // –í–∞–ª–∏–¥–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞
        if (
            !aiResult.price_range ||
            typeof aiResult.price_range.min !== "number" ||
            typeof aiResult.price_range.max !== "number" ||
            aiResult.price_range.min <= 0 ||
            aiResult.price_range.max <= 0 ||
            aiResult.price_range.min > aiResult.price_range.max ||
            typeof aiResult.reason_short !== "string" ||
            typeof aiResult.reason_long !== "string"
        ) {
            console.error("Invalid AI result structure:", aiResult);
            return new Response(
                JSON.stringify({
                    aiMin: null,
                    aiMax: null,
                    aiFailed: true,
                    reasonShort: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –ò–ò',
                    reasonLong: '–ò–ò –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ –≤ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ. –ü–æ–∫–∞–∑–∞–Ω–∞ –±–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É.',
                    warnings: []
                }),
                { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
            );
        }

        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç AI
        return new Response(
            JSON.stringify({
                aiMin: Math.round(aiResult.price_range.min),
                aiMax: Math.round(aiResult.price_range.max),
                reasonShort: aiResult.reason_short,
                reasonLong: aiResult.reason_long,
                warnings: aiResult.warnings || [],
                aiFailed: false
            }),
            { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
        );

    } catch (err) {
        console.error("Error in ai-price-estimate:", err);
        return new Response(
            JSON.stringify({
                aiMin: null,
                aiMax: null,
                aiFailed: true,
                reasonShort: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞',
                reasonLong: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–∫–∞–∑–∞–Ω–∞ –±–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É.',
                warnings: []
            }),
            { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
        );
    }
});
