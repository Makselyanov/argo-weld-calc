# üîß –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –≤ ai-price-estimate

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

**–û—à–∏–±–∫–∞ –≤ –ª–æ–≥–∞—Ö Supabase:**
```
Failed to parse request JSON in ai-price-estimate: SyntaxError: Unexpected end of JSON input
```

**–ü—Ä–∏—á–∏–Ω–∞:** Edge-—Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–∞–ª–∞ –ø—É—Å—Ç–æ–µ –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —á—Ç–µ–Ω–∏–µ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞** (—Å—Ç—Ä–æ–∫–∏ 20-42)

**–ë—ã–ª–æ:**
```typescript
let data;
try {
    data = await req.json();
} catch (err) {
    console.error('Failed to parse request JSON...');
    // –≤–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏
}
```

**–°—Ç–∞–ª–æ:**
```typescript
let data;
let rawBody = '';
try {
    rawBody = await req.text();  // ‚úÖ —á–∏—Ç–∞–µ–º —Å—ã—Ä–æ–µ —Ç–µ–ª–æ
    console.log('Raw request body (first 1000 chars):', rawBody.slice(0, 1000));
    data = JSON.parse(rawBody);  // ‚úÖ –ø–∞—Ä—Å–∏–º –≤—Ä—É—á–Ω—É—é
} catch (err) {
    console.error('Failed to parse request JSON in ai-price-estimate:', err);
    console.error('Raw body (first 1000 chars):', rawBody.slice(0, 1000));  // ‚úÖ –ª–æ–≥–∏—Ä—É–µ–º —Å—ã—Ä–æ–µ —Ç–µ–ª–æ
    return new Response(
        JSON.stringify({
            aiMin: null,
            aiMax: null,
            aiFailed: true,
            reasonShort: '–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ –∑–∞–ø—Ä–æ—Å–∞',
            reasonLong: '–°–µ—Ä–≤–µ—Ä –Ω–µ —Å–º–æ–≥ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–∞—Å—á—ë—Ç–∞. –ü–æ–∫–∞–∑–∞–Ω–∞ –±–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É.',
            warnings: []
        }),
        { headers: { 'Content-Type': 'application/json' }, status: 200 }
    );
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å—ã—Ä–æ–µ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- ‚úÖ –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ `req.text()` ‚Äî —Ç–µ–ª–æ —á–∏—Ç–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
- ‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ —á–µ—Ä–µ–∑ `JSON.parse()` —Å —è–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫

---

### 2. **–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞** (7 –º–µ—Å—Ç)

–í—Å–µ –æ—Ç–≤–µ—Ç—ã —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç:

```typescript
{
  aiMin: number | null;
  aiMax: number | null;
  aiFailed: boolean;
  reasonShort: string;
  reasonLong: string;
  warnings: string[];
}
```

**–ó–∞–º–µ–Ω–µ–Ω–æ:**
- ‚ùå `useFallback: true, reason: "..."` 
- ‚úÖ `aiMin: null, aiMax: null, aiFailed: true, reasonShort: "...", reasonLong: "...", warnings: []`

**–ú–µ—Å—Ç–∞ –∑–∞–º–µ–Ω—ã:**
1. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ API –∫–ª—é—á–∞ (—Å—Ç—Ä–æ–∫–∏ 8-21)
2. –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ (—Å—Ç—Ä–æ–∫–∏ 20-42)
3. –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ OpenRouter (—Å—Ç—Ä–æ–∫–∏ 239-252)
4. –û—à–∏–±–∫–∞ API OpenRouter (—Å—Ç—Ä–æ–∫–∏ 254-267)
5. –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò (—Å—Ç—Ä–æ–∫–∏ 295-306)
6. –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞ –ò–ò (—Å—Ç—Ä–æ–∫–∏ 316-327)
7. –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –ò–ò (—Å—Ç—Ä–æ–∫–∏ 337-348)
8. –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (—Å—Ç—Ä–æ–∫–∏ 363-376)

---

### 3. **–§—Ä–æ–Ω—Ç–µ–Ω–¥** (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

–§–∞–π–ª `src/pages/NewCalculation.tsx` —É–∂–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
- ‚úÖ –§–æ—Ä–º–∏—Ä—É–µ—Ç `payload` –∫–∞–∫ –æ–±—ä–µ–∫—Ç
- ‚úÖ –ü–µ—Ä–µ–¥–∞—ë—Ç –≤ `supabase.functions.invoke('ai-price-estimate', { body: payload })`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `data.aiFailed` –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—à–∏–±–∫–∏
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `data.aiMin` –∏ `data.aiMax` –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ü–µ–Ω—ã

---

## üìä –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ Edge-—Ñ—É–Ω–∫—Ü–∏–∏

### –£—Å–ø–µ—à–Ω—ã–π AI-—Ä–∞—Å—á—ë—Ç:
```json
{
  "aiMin": 8500,
  "aiMax": 10500,
  "reasonShort": "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å–≤–∞—Ä–∫–∞...",
  "reasonLong": "–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –ü–æ –≤–∞—à–µ–π –∑–∞—è–≤–∫–µ...",
  "warnings": [],
  "aiFailed": false
}
```

### –õ—é–±–∞—è –æ—à–∏–±–∫–∞:
```json
{
  "aiMin": null,
  "aiMax": null,
  "aiFailed": true,
  "reasonShort": "–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ –∑–∞–ø—Ä–æ—Å–∞",
  "reasonLong": "–°–µ—Ä–≤–µ—Ä –Ω–µ —Å–º–æ–≥ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–∞—Å—á—ë—Ç–∞. –ü–æ–∫–∞–∑–∞–Ω–∞ –±–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É.",
  "warnings": []
}
```

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –¢–µ–ø–µ—Ä—å –≤ –ª–æ–≥–∞—Ö Supabase –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ:

**–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ:**
```
Raw request body (first 1000 chars): {"description":"–°–≤–∞—Ä–∫–∞ —Ä–∞–º—ã","typeOfWork":"welding",...}
OpenRouter raw response (first 1000 chars): {"id":"gen-...","choices":[...
```

**–ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞:**
```
Failed to parse request JSON in ai-price-estimate: SyntaxError: Unexpected end of JSON input
Raw body (first 1000 chars): 
```

**–ü—Ä–∏ –æ—à–∏–±–∫–µ OpenRouter:**
```
OpenRouter fetch error: AbortError: The operation was aborted
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞

- [x] –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ `req.text()` –¥–ª—è —á—Ç–µ–Ω–∏—è —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
- [x] –ü–∞—Ä—Å–∏–Ω–≥ —á–µ—Ä–µ–∑ `JSON.parse()` —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—ã—Ä–æ–≥–æ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
- [x] –í—Å–µ `useFallback` –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ `aiFailed`
- [x] –ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –≤–æ –≤—Å–µ—Ö –≤–µ—Ç–∫–∞—Ö
- [x] –§—Ä–æ–Ω—Ç–µ–Ω–¥ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç

---

## üöÄ –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–µ–ø–ª–æ—è

```powershell
cd C:\argo-weld-calc
npm run build
git add .
git commit -m "fix: ai-price-estimate request parsing"
git push
npx supabase functions deploy ai-price-estimate
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Supabase:
```powershell
npx supabase functions logs ai-price-estimate --follow
```

### 2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ:**
```
Raw request body (first 1000 chars): {"description":"–°–≤–∞—Ä–∫–∞ —Ä–∞–º—ã",...}
OpenRouter raw response (first 1000 chars): {"id":"gen-...
```

**–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ:**
```
Raw body (first 1000 chars): 
```
–ó–Ω–∞—á–∏—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—É—Å—Ç–æ–µ —Ç–µ–ª–æ.

**–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ:**
```
Raw body (first 1000 chars): undefined
```
–ó–Ω–∞—á–∏—Ç —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤–æ–æ–±—â–µ.

---

**–ì–æ—Ç–æ–≤–æ!** –û—à–∏–±–∫–∞ "Unexpected end of JSON input" –±–æ–ª—å—à–µ –Ω–µ –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–ª—è—Ç—å—Å—è.
