# Material List Extension - Implementation Summary

## Обзор изменений

В проект добавлена поддержка расширенного списка материалов для сварочных работ.

### Старый список материалов (5 позиций):
- Черная сталь
- Нержавейка
- Алюминий
- Чугун
- Другое

### Новый список материалов (7 позиций):
- **Черный металл** (был "Черная сталь")
- **Нержавейка**
- **Алюминий**
- **Чугун**
- **Медь** (новый)
- **Латунь** (новый)
- **Титан** (новый)

---

## Изменённые файлы

### 1. `src/types/calculation.ts`
- Обновлён тип `Material`
- Добавлены новые значения: `copper`, `brass`, `titanium`
- Переименовано `steel` → `black_metal`
- Удалено `other`

### 2. `src/constants/calculationMappings.ts`
- Обновлён массив `MATERIALS` с новыми значениями и лейблами
- Массив используется во всех компонентах для отображения списка материалов

### 3. `src/utils/pricing.ts`
- Добавлена логика расчёта для новых материалов:
  - Медь/Латунь: +5000₽ к базовой цене
  - Титан: +7000₽ к базовой цене (самый дорогой материал)

### 4. `DATABASE_MIGRATION.md` (новый файл)
- Руководство по миграции базы данных
- SQL-скрипты для обновления схемы
- Инструкции по обновлению существующих данных

---

## Автоматические обновления

Следующие компоненты обновятся **автоматически** благодаря использованию констант:

### ✅ UI Компоненты
- **`NewCalculation.tsx`** - Шаг 2 "Параметры работ"
  - Список материалов теперь содержит 7 элементов
  - UI остался в стиле chips/toggle buttons
  - Материал автоматически передаётся в форму

### ✅ Отображение данных
- **`NewCalculation.tsx`** - Шаг 2, Summary блок
  - Показывает выбранный материал с правильным лейблом
- **`NewCalculation.tsx`** - Шаг 3, Price Display
  - Отображает материал в описании цены

### ✅ Расчёт цены
- **`calculatePrice()`** в `pricing.ts`
  - Локальный калькулятор учитывает новые материалы
  
- **`calculatePriceWithAI()`** в `NewCalculation.tsx`
  - Передаёт материал в Edge Function `ai-price-estimate`

### ✅ Edge Functions (Supabase)
- **`ai-price-estimate/index.ts`**
  - Получает материал через `data.material`
  - Передаёт в промт для AI
  - AI учитывает материал при расчёте цены

- **`send-weld-notify/index.ts`**
  - Отправляет материал в Telegram-уведомление
  - Формат: `Материал: {material}`

### ✅ Сохранение данных
- **`calculationSupabaseService.ts`**
  - `saveCalculation()` передаёт `material` в БД
  - `getAllCalculations()` получает материал из БД
  - Материал сохраняется в таблице `calculations`

### ✅ История
- **`History.tsx`**
  - Отображает расчёты с материалом (через `getAllCalculations`)

---

## Требуется ручная настройка

### ⚠️ База данных Supabase

**Необходимо обновить схему таблицы `calculations`:**

1. Проверить тип колонки `material` — должен быть `TEXT` или `VARCHAR`
2. Если используется ENUM constraint — удалить или обновить
3. Обновить существующие записи: `'steel'` → `'black_metal'`

См. подробные инструкции в файле `DATABASE_MIGRATION.md`.

---

## Git Commit

```bash
git add .
git commit -m "feat: add extended material list and integrate material into calculations"
git push
```

---

## Проверка работоспособности

### Пошаговая проверка:

1. **UI выбора материала:**
   - Открыть `/new-calculation`
   - Перейти на Шаг 2
   - Убедиться, что отображается 7 материалов
   - Выбрать каждый материал — должен подсвечиваться

2. **Расчёт цены:**
   - Заполнить Шаг 1
   - Выбрать параметры на Шаге 2 (включая материал)
   - Проверить, что цена рассчитывается
   - Для меди/латуни/титана цена должна быть выше

3. **AI расчёт:**
   - При переходе на Шаг 3 должен срабатывать AI расчёт
   - Материал должен учитываться в промте

4. **Сохранение:**
   - Нажать "Заказать работу"
   - Проверить, что расчёт сохранился в БД с правильным материалом

5. **История:**
   - Открыть `/history`
   - Убедиться, что материал отображается корректно

6. **Telegram уведомление:**
   - После заказа должно прийти уведомление
   - Должно содержать правильный материал

---

## FAQ

**Q: Нужно ли обновлять старые расчёты?**  
A: Если в БД есть записи с `material = 'steel'`, желательно обновить на `'black_metal'` для консистентности.

**Q: Что делать с расчётами, где материал = 'other'?**  
A: Можно оставить как есть или установить `NULL`. Новые расчёты не могут иметь значение 'other'.

**Q: Изменится ли логика AI расчёта?**  
A: Да, AI теперь будет получать более точную информацию о материале и учитывать специфику работы с медью, латунью и титаном.

---

## Контакты

При возникновении проблем или вопросов — создайте Issue в репозитории.
