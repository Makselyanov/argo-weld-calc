# üîß –û—Ç—á—ë—Ç: –û—Ç–ª–∞–¥–∫–∞ Edge-—Ñ—É–Ω–∫—Ü–∏–∏ ai-price-estimate

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

**–û—à–∏–±–∫–∞ –≤ –ª–æ–≥–∞—Ö Supabase:**
```
Error in ai-price-estimate: SyntaxError: Unexpected end of JSON input
```

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ù–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è fallback: "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —á–µ—Ä–µ–∑ –Ω–µ–π—Ä–æ—Å–µ—Ç—å"
- –ò–ò-—Ä–∞—Å—á—ë—Ç –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–π —Ñ–∞–π–ª: `supabase/functions/ai-price-estimate/index.ts`

#### 1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞** (—Å—Ç—Ä–æ–∫–∏ 21-38)

**–ë—ã–ª–æ:**
```typescript
const data = await req.json();
```

**–°—Ç–∞–ª–æ:**
```typescript
// –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
let data;
try {
    data = await req.json();
} catch (err) {
    console.error('Failed to parse request JSON in ai-price-estimate:', err);
    return new Response(
        JSON.stringify({
            aiFailed: true,
            reasonShort: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ò–ò',
            reasonLong: '–°–µ—Ä–≤–∏—Å —Ä–∞—Å—á—ë—Ç–∞ –ø–æ–ª—É—á–∏–ª –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø–æ–∫–∞–∑–∞–Ω –±–∞–∑–æ–≤—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º.',
            warnings: ['–°–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è —Ä–∞—Å—á—ë—Ç–∞.'],
            totalMin: null,
            totalMax: null,
        }),
        { headers: { 'Content-Type': 'application/json' }, status: 200 }
    );
}
```

**–ó–∞—á–µ–º:**
- –ï—Å–ª–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON, —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ —É–ø–∞–¥—ë—Ç
- –í–µ—Ä–Ω—ë—Ç—Å—è –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≤–º–µ—Å—Ç–æ –∫—Ä–∞—à–∞

---

#### 2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç OpenRouter** (—Å—Ç—Ä–æ–∫–∏ 260-280)

**–ë—ã–ª–æ:**
```typescript
const aiResponse = await response.json();
const content = aiResponse.choices?.[0]?.message?.content;
```

**–°—Ç–∞–ª–æ:**
```typescript
// –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç OpenRouter
const raw = await response.text();
console.log('OpenRouter raw response (first 1000 chars):', raw.slice(0, 1000));

let aiResponse: any;
try {
    aiResponse = JSON.parse(raw);
} catch (err) {
    console.error('Failed to parse OpenRouter JSON in ai-price-estimate:', err);
    console.error('Raw response:', raw);
    return new Response(
        JSON.stringify({
            aiFailed: true,
            reasonShort: '–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –ò–ò',
            reasonLong: '–°–µ—Ä–≤–∏—Å –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ –≤–µ—Ä–Ω—É–ª –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö, –ø–æ—ç—Ç–æ–º—É –ø–æ–∫–∞–∑–∞–Ω –±–∞–∑–æ–≤—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º.',
            warnings: ['–°–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è —Ä–∞—Å—á—ë—Ç–∞.'],
            totalMin: null,
            totalMax: null,
        }),
        { headers: { 'Content-Type': 'application/json' }, status: 200 }
    );
}

const content = aiResponse.choices?.[0]?.message?.content;
```

**–ó–∞—á–µ–º:**
- –ï—Å–ª–∏ OpenRouter –≤–µ—Ä–Ω—ë—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON, –º—ã —É–≤–∏–¥–∏–º RAW-–æ—Ç–≤–µ—Ç –≤ –ª–æ–≥–∞—Ö
- –§—É–Ω–∫—Ü–∏—è –Ω–µ —É–ø–∞–¥—ë—Ç, –∞ –≤–µ—Ä–Ω—ë—Ç fallback
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–≤—ã—Ö 1000 —Å–∏–º–≤–æ–ª–æ–≤ –ø–æ–º–æ–∂–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –¢–µ–ø–µ—Ä—å –≤ –ª–æ–≥–∞—Ö Supabase –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ:

1. **–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –≤–æ –≤—Ö–æ–¥—è—â–µ–º –∑–∞–ø—Ä–æ—Å–µ:**
   ```
   Failed to parse request JSON in ai-price-estimate: <–¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏>
   ```

2. **–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –≤ –æ—Ç–≤–µ—Ç–µ OpenRouter:**
   ```
   OpenRouter raw response (first 1000 chars): <–Ω–∞—á–∞–ª–æ –æ—Ç–≤–µ—Ç–∞>
   Failed to parse OpenRouter JSON in ai-price-estimate: <–¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏>
   Raw response: <–ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç>
   ```

3. **–ï—Å–ª–∏ OpenRouter –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç:**
   ```
   No content in AI response
   ```

4. **–ï—Å–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ AI –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞:**
   ```
   Invalid AI result structure: <–æ–±—ä–µ–∫—Ç aiResult>
   ```

---

## üìã –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ —Ñ—É–Ω–∫—Ü–∏–∏

–§—É–Ω–∫—Ü–∏—è –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTTP 200 —Å JSON. –í–æ–∑–º–æ–∂–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:

### –£—Å–ø–µ—à–Ω—ã–π AI-—Ä–∞—Å—á—ë—Ç:
```json
{
  "totalMin": 8500,
  "totalMax": 10500,
  "reasonShort": "–ö–æ—Ä–æ—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ",
  "reasonLong": "–†–∞–∑–≤—ë—Ä–Ω—É—Ç–æ–µ –ö–ü",
  "warnings": []
}
```

### Fallback (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç):
```json
{
  "useFallback": true,
  "reason": "OpenRouter timeout or network error"
}
```

### –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ (–Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç):
```json
{
  "aiFailed": true,
  "reasonShort": "–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –ò–ò",
  "reasonLong": "–°–µ—Ä–≤–∏—Å –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ –≤–µ—Ä–Ω—É–ª –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö...",
  "warnings": ["–°–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è —Ä–∞—Å—á—ë—Ç–∞."],
  "totalMin": null,
  "totalMax": null
}
```

---

## üöÄ –î–µ–ø–ª–æ–π

```powershell
# –ó–∞–¥–µ–ø–ª–æ–π—Ç–µ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
supabase functions deploy ai-price-estimate

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
supabase functions logs ai-price-estimate --follow
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç —Å –ª—é–±—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
3. –î–æ–∂–¥–∏—Ç–µ—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Supabase

```powershell
supabase functions logs ai-price-estimate
```

**–ß—Ç–æ –∏—Å–∫–∞—Ç—å –≤ –ª–æ–≥–∞—Ö:**

‚úÖ **–£—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å:**
```
OpenRouter raw response (first 1000 chars): {"id":"gen-...","choices":[{"message":{"content":"{\"price_range\":{\"min\":8500,\"max\":10500}...
```

‚ùå **–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞:**
```
Failed to parse request JSON in ai-price-estimate: SyntaxError: Unexpected end of JSON input
```

‚ùå **–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞ OpenRouter:**
```
Failed to parse OpenRouter JSON in ai-price-estimate: SyntaxError: Unexpected token < in JSON at position 0
Raw response: <html>...
```

---

## üêõ –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–æ–∫

### –û—à–∏–±–∫–∞: "Unexpected end of JSON input"

**–ü—Ä–∏—á–∏–Ω–∞:** –ü—É—Å—Ç–æ–π –∏–ª–∏ –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–π JSON

**–†–µ—à–µ–Ω–∏–µ:** 
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ OpenRouter –≤–µ—Ä–Ω—É–ª –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç (–Ω–µ –æ–±—Ä–µ–∑–∞–Ω –ø–æ —Ç–∞–π–º–∞—É—Ç—É)

### –û—à–∏–±–∫–∞: "Unexpected token < in JSON"

**–ü—Ä–∏—á–∏–Ω–∞:** OpenRouter –≤–µ—Ä–Ω—É–ª HTML –≤–º–µ—Å—Ç–æ JSON (–æ–±—ã—á–Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—à–∏–±–∫–∏)

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á OpenRouter
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–ª–∞–Ω—Å –Ω–∞ OpenRouter
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –º–æ–¥–µ–ª—å `openai/gpt-4o-mini` –¥–æ—Å—Ç—É–ø–Ω–∞

### –û—à–∏–±–∫–∞: "No content in AI response"

**–ü—Ä–∏—á–∏–Ω–∞:** OpenRouter –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π `choices` –º–∞—Å—Å–∏–≤

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ–º–ø—Ç (–≤–æ–∑–º–æ–∂–Ω–æ, —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –º–æ–¥–µ–ª—å –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ –∑–∞–ø—Ä–æ—Å –∏–∑-–∑–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç

- [x] –î–æ–±–∞–≤–ª–µ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ JSON
- [x] –î–æ–±–∞–≤–ª–µ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ OpenRouter
- [x] –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ RAW-–æ—Ç–≤–µ—Ç–∞ –æ—Ç OpenRouter
- [x] –í—Å–µ `.json()` –≤—ã–∑–æ–≤—ã –æ–±—ë—Ä–Ω—É—Ç—ã –≤ try-catch
- [x] –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ –∏–∑–º–µ–Ω—ë–Ω (—Å–æ–≤–º–µ—Å—Ç–∏–º —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º)
- [x] –§—É–Ω–∫—Ü–∏—è –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTTP 200 (–Ω–µ –ø–∞–¥–∞–µ—Ç)

---

## üìû –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ó–∞–¥–µ–ø–ª–æ–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é:**
   ```powershell
   supabase functions deploy ai-price-estimate
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:**
   ```powershell
   supabase functions logs ai-price-estimate --follow
   ```

3. **–°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç** –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

4. **–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ª–æ–≥–∏:**
   - –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ "OpenRouter raw response" ‚Äî –∑–Ω–∞—á–∏—Ç –∑–∞–ø—Ä–æ—Å –¥–æ—à—ë–ª –¥–æ OpenRouter
   - –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ "Failed to parse" ‚Äî —Å–º–æ—Ç—Ä–∏—Ç–µ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω–µ —Ä–∞—Å–ø–∞—Ä—Å–∏–ª–æ—Å—å
   - –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ "Invalid AI result structure" ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ AI –≤–µ—Ä–Ω—É–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON

---

**–ì–æ—Ç–æ–≤–æ!** –§—É–Ω–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å –Ω–µ –±—É–¥–µ—Ç –ø–∞–¥–∞—Ç—å —Å "Unexpected end of JSON input" –∏ –±—É–¥–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–æ–∫.
