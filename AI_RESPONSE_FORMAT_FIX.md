# üìã –û—Ç—á—ë—Ç: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ –æ—Ç–≤–µ—Ç–∞ Edge-—Ñ—É–Ω–∫—Ü–∏–∏ ai-price-estimate

## ‚úÖ –ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ

### –§–∞–π–ª: `supabase/functions/ai-price-estimate/index.ts`

---

## üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –æ—Ç–≤–µ—Ç–∞

### 1. **–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞** (—Å—Ç—Ä–æ–∫–∏ 25-37)

**–ë—ã–ª–æ:**
```typescript
return new Response(
    JSON.stringify({
        aiFailed: true,
        reasonShort: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ò–ò',
        reasonLong: '–°–µ—Ä–≤–∏—Å —Ä–∞—Å—á—ë—Ç–∞ –ø–æ–ª—É—á–∏–ª –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø–æ–∫–∞–∑–∞–Ω –±–∞–∑–æ–≤—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º.',
        warnings: ['–°–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è —Ä–∞—Å—á—ë—Ç–∞.'],
        totalMin: null,  // ‚ùå –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        totalMax: null,  // ‚ùå –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
    }),
    { headers: { 'Content-Type': 'application/json' }, status: 200 }
);
```

**–°—Ç–∞–ª–æ:**
```typescript
return new Response(
    JSON.stringify({
        aiFailed: true,
        reasonShort: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ò–ò',
        reasonLong: '–°–µ—Ä–≤–µ—Ä –Ω–µ —Å–º–æ–≥ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–∞—Å—á—ë—Ç–∞. –ü–æ–∫–∞–∑–∞–Ω–∞ –±–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É.',
        warnings: ['–°–ª—É–∂–µ–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å JSON –≤ Edge-—Ñ—É–Ω–∫—Ü–∏–∏.'],
        aiMin: null,  // ‚úÖ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        aiMax: null,  // ‚úÖ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
    }),
    { headers: { 'Content-Type': 'application/json' }, status: 200 }
);
```

---

### 2. **–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞ OpenRouter** (—Å—Ç—Ä–æ–∫–∏ 267-280)

**–ë—ã–ª–æ:**
```typescript
return new Response(
    JSON.stringify({
        aiFailed: true,
        reasonShort: '–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –ò–ò',
        reasonLong: '–°–µ—Ä–≤–∏—Å –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ –≤–µ—Ä–Ω—É–ª –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö, –ø–æ—ç—Ç–æ–º—É –ø–æ–∫–∞–∑–∞–Ω –±–∞–∑–æ–≤—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º.',
        warnings: ['–°–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è —Ä–∞—Å—á—ë—Ç–∞.'],
        totalMin: null,  // ‚ùå –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        totalMax: null,  // ‚ùå –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
    }),
    { headers: { 'Content-Type': 'application/json' }, status: 200 }
);
```

**–°—Ç–∞–ª–æ:**
```typescript
return new Response(
    JSON.stringify({
        aiFailed: true,
        reasonShort: '–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –ò–ò',
        reasonLong: '–°–µ—Ä–≤–µ—Ä –Ω–µ —Å–º–æ–≥ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–∞—Å—á—ë—Ç–∞. –ü–æ–∫–∞–∑–∞–Ω–∞ –±–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É.',
        warnings: ['–°–ª—É–∂–µ–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å JSON –≤ Edge-—Ñ—É–Ω–∫—Ü–∏–∏.'],
        aiMin: null,  // ‚úÖ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        aiMax: null,  // ‚úÖ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
    }),
    { headers: { 'Content-Type': 'application/json' }, status: 200 }
);
```

---

### 3. **–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç AI** (—Å—Ç—Ä–æ–∫–∏ 338-348)

**–ë—ã–ª–æ:**
```typescript
return new Response(
    JSON.stringify({
        totalMin: Math.round(aiResult.price_range.min),  // ‚ùå –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        totalMax: Math.round(aiResult.price_range.max),  // ‚ùå –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        reasonShort: aiResult.reason_short,
        reasonLong: aiResult.reason_long,
        warnings: aiResult.warnings || []
    }),
    { status: 200, headers: { "Content-Type": "application/json" } }
);
```

**–°—Ç–∞–ª–æ:**
```typescript
return new Response(
    JSON.stringify({
        aiMin: Math.round(aiResult.price_range.min),  // ‚úÖ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        aiMax: Math.round(aiResult.price_range.max),  // ‚úÖ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        reasonShort: aiResult.reason_short,
        reasonLong: aiResult.reason_long,
        warnings: aiResult.warnings || [],
        aiFailed: false  // ‚úÖ –¥–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ —É—Å–ø–µ—Ö–∞
    }),
    { status: 200, headers: { "Content-Type": "application/json" } }
);
```

---

## üìä –ò—Ç–æ–≥–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ —Ñ—É–Ω–∫—Ü–∏–∏

### –£—Å–ø–µ—à–Ω—ã–π AI-—Ä–∞—Å—á—ë—Ç:
```json
{
  "aiMin": 8500,
  "aiMax": 10500,
  "reasonShort": "–ö–æ—Ä–æ—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ",
  "reasonLong": "–†–∞–∑–≤—ë—Ä–Ω—É—Ç–æ–µ –ö–ü –æ—Ç –ª–∏—Ü–∞ —Å–≤–∞—Ä—â–∏–∫–∞",
  "warnings": [],
  "aiFailed": false
}
```

### –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ (–≤—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –æ—Ç–≤–µ—Ç OpenRouter):
```json
{
  "aiFailed": true,
  "reasonShort": "–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –ò–ò",
  "reasonLong": "–°–µ—Ä–≤–µ—Ä –Ω–µ —Å–º–æ–≥ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–∞—Å—á—ë—Ç–∞. –ü–æ–∫–∞–∑–∞–Ω–∞ –±–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É.",
  "warnings": ["–°–ª—É–∂–µ–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å JSON –≤ Edge-—Ñ—É–Ω–∫—Ü–∏–∏."],
  "aiMin": null,
  "aiMax": null
}
```

### Fallback (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç, –¥–ª—è –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫):
```json
{
  "useFallback": true,
  "reason": "OpenRouter timeout or network error"
}
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞

- [x] –í—Å–µ `totalMin/totalMax` –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ `aiMin/aiMax`
- [x] –î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ `aiFailed: false` –≤ —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
- [x] –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–µ–∫—Å—Ç—ã –æ—à–∏–±–æ–∫ –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è
- [x] –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ `.json()` –æ–±—ë—Ä–Ω—É—Ç –≤ try-catch (—Å—Ç—Ä–æ–∫–∞ 24)
- [x] –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–µ–Ω –¥–ª—è –≤—Å–µ—Ö —Å–ª—É—á–∞–µ–≤
- [x] TypeScript lint-–æ—à–∏–±–∫–∏ ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è Deno Edge Functions

---

## üöÄ –î–µ–ø–ª–æ–π

```powershell
# –ó–∞–¥–µ–ø–ª–æ–π—Ç–µ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
cd c:\argo-weld-calc
supabase functions deploy ai-price-estimate

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
supabase functions logs ai-price-estimate --follow
```

---

## üìù –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

**–ò–∑–º–µ–Ω–µ–Ω–æ:** 3 –±–ª–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ—Ç–≤–µ—Ç–∞ –≤ —Ñ–∞–π–ª–µ `supabase/functions/ai-price-estimate/index.ts`

**–¶–µ–ª—å:** –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –æ—Ç–≤–µ—Ç–∞ —Ñ—É–Ω–∫—Ü–∏–∏ ‚Äî —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø–æ–ª—è `aiMin/aiMax` –≤–º–µ—Å—Ç–æ `totalMin/totalMax`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –§—Ä–æ–Ω—Ç–µ–Ω–¥ –±—É–¥–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –æ—Ç Edge-—Ñ—É–Ω–∫—Ü–∏–∏, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, —É—Å–ø–µ—à–µ–Ω –ª–∏ AI-—Ä–∞—Å—á—ë—Ç –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞

---

**–ì–æ—Ç–æ–≤–æ!** –§—É–Ω–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞.
